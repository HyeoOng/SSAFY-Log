const headers = { 'Content-Type': 'application/json' };
const {createApp, ref, onMounted} = Vue;
const app = createApp({
    setup(){
        const loginEmail = ref(sessionStorage.getItem("loginEmail"));
        const loginName = ref(sessionStorage.getItem("loginName"));
        const loginCheck = function(){
            if(!loginEmail.value){
                alert("로그인 후 이용해 주세요");
                location.href = "/index.html";
            }
        }
        const logout = function(){
            fetch("/logout", {method: "GET"});
            sessionStorage.removeItem("loginEmail");
            sessionStorage.removeItem("loginName");
            location.href = "/index.html";
        }
        const diagnosisAI = async function(){
            const question = document.getElementById("symptomsText").value;
            
            if(question.length>100){
                alert("100자 이내로 작성해주세요");
                return;
            }
            let data = JSON.stringify({ question });
            data = await fetch("/api/ai", {
                method: "POST",
                headers,
                body: data
            });
            if(data.ok){
                data = await data.json();
                setResponsed(data.result,data.specialties);
            }else{
                document.getElementById("symptomsText").value = "";
                alert("다시 증상을 입력해주세요");
            }
        }
        const setResponsed = async function (text,kwd) {
            document.getElementById("symptomsText").setAttribute("readonly", true);
            const responseBox = document.getElementById("responseBox");
            let htmlText = `
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">AI 진단</h6>
                </div>
                <div class="card-body">
                    <span class="font-weight-bold text-danger">${text}</span> 증상이 의심 됩니다<br>증상에 대한 의사들을 추천해드리겠습니다.
                </div>
            </div>`

            let data = JSON.stringify({ kwd });
            
            data = await fetch("/api/doctor/ai", {
                method: "POST",
                headers,
                body: data
            });
            if(data.ok){
                data = await data.json();
                htmlText+=`<div style="display: flex; flex-direction: row; gap: 10px; margin-bottom:20px">`
                for(let doctor of data){
                    htmlText+=`
                    <div class="card" style="width: 18rem; margin-right:10px;">
                        <img src="http://localhost:8080/img/doctorping.jpeg" class="card-img-top" alt="...">
                        <div class="card" >
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">이름 : ${doctor.name}</li>
                                <li class="list-group-item">경력 : ${doctor.experienceYears}년</li>
                                <li class="list-group-item">${doctor.specialtyName}</li>
                            </ul>
                            <a href="#" class="btn btn-primary" style="width: 10rem; margin:5px auto;">접수하기</a>
                        </div>
                    </div>
                    `;
                }
                htmlText+=`</div>`
            }else{
                alert("의사 다 죽었습니다");
            }
            responseBox.innerHTML = htmlText;
            document.getElementById("symptomsBtn").remove();
        }
        onMounted(()=>{
            loginCheck();
        })
        return{
            loginEmail,
            loginName,
            loginCheck,
            logout,
            diagnosisAI,
            setResponsed,
        }
    }
});
app.mount("#app");